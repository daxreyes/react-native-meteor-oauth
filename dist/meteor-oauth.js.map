{"version":3,"sources":["../src/meteor-oauth.js"],"names":["styles","buttonContainer","flexDirection","justifyContent","button","flex","buttonLogin","backgroundColor","buttonLogout","buttonLoginText","textAlign","paddingVertical","paddingHorizontal","buttonLogoutText","text","marginBottom","view","alignSelf","Login","props","state","stage","targetUrl","login","url","providerConfig","randomToken","stateParam","callbackUrl","queryString","stringify","client_id","clientId","redirect_uri","scope","extraRequestParams","setState","navigation","regex","RegExp","parsedUrl","exec","setTimeout","meteorUri","meteorServerProtocol","meteorServerDomain","provider","toLowerCase","fetch","then","res","$","load","config","JSON","parse","_login","oauth","credentialToken","credentialSecret","err","console","error","catch","renderStage","user","profile","name","logout","initial","webView","uri","confirmation","propStyles","Component","propTypes","PropTypes","string","isRequired","object","defaultProps","classNames","loginStyle","redirectUrl","encode","params"],"mappings":"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","file":"meteor-oauth.js","sourcesContent":["import React from 'react'\nimport { ActivityIndicator, Text, TouchableOpacity, View, Modal, WebView } from 'react-native'\nimport cheerio from 'cheerio'\nimport qs from 'qs'\nimport randomize from 'randomatic'\nimport Base64 from 'base-64'\nimport Meteor, { createContainer } from 'react-native-meteor'\n\nimport providerConfigs from '../provider-configs'\n\nconst styles = {\n  buttonContainer: { flexDirection: 'row', justifyContent: 'space-around' },\n  button: { flex: -1 },\n  buttonLogin: { backgroundColor: '#bbb'},\n  buttonLogout: { backgroundColor: '#bbb'},\n  buttonLoginText: { textAlign: 'center', paddingVertical: 12, paddingHorizontal: 40 },\n  buttonLogoutText: { textAlign: 'center', paddingVertical: 12, paddingHorizontal: 40 },\n  text: { textAlign: 'center', marginBottom: 15 },\n  view: { flex: 1, alignSelf: 'stretch', justifyContent: 'center' }\n}\n\nclass Login extends React.Component {\n  static propTypes = {\n    provider: React.PropTypes.string.isRequired,\n    callbackUrl: React.PropTypes.string.isRequired,\n    meteorServerDomain: React.PropTypes.string.isRequired,\n    meteorServerProtocol: React.PropTypes.string.isRequired,\n    clientId: React.PropTypes.string.isRequired,\n    scope: React.PropTypes.string,\n    url: React.PropTypes.string,\n    extraRequestParams: React.PropTypes.string,\n    styles: React.PropTypes.object\n  }\n\n  static defaultProps = {\n    styles: {},\n    classNames: {}\n  }\n\n  state = {\n    stage: 'initial',\n    targetUrl: ''\n  }\n  \n  constructor (props) {\n    super(props)\n\n    this.providerConfig = providerConfigs[this.props.provider] || {}\n\n    const propStyles = this.props.styles || {}\n\n    this.styles = {\n      buttonContainer: Object.assign({}, styles.buttonContainer, propStyles.buttonContainer),\n      buttonLogin: Object.assign({}, styles.button, styles.buttonLogin, this.providerConfig.styles.buttonLogin, propStyles.buttonLogin),\n      buttonLogout: Object.assign({}, styles.button, styles.buttonLogout, this.providerConfig.styles.buttonLogout, propStyles.buttonLogout),\n      buttonLoginText: Object.assign({}, styles.buttonLoginText, this.providerConfig.styles.buttonLoginText, propStyles.buttonLoginText),\n      buttonLogoutText: Object.assign({}, styles.buttonLogoutText, this.providerConfig.styles.buttonLogoutText, propStyles.buttonLogoutText),\n      text: Object.assign({}, styles.text, propStyles.text),\n      view: Object.assign({}, styles.view, propStyles.view),  \n    }\n  }\n\n\n  login = () => {\n    const url = this.props.url || this.providerConfig.url\n    const randomToken = randomize('*', 10)\n    const state = stateParam('popup', randomToken, this.props.callbackUrl)\n\n    const queryString = qs.stringify(Object.assign({\n      client_id: this.props.clientId,\n      redirect_uri: this.props.callbackUrl,\n      scope: this.props.scope || this.providerConfig.scope,\n      state\n    }, this.providerConfig.extraRequestParams, this.props.extraRequestParams))\n\n    this.setState({\n      targetUrl: `${url}?${queryString}`,\n      stage: 'webView'\n    })\n  }\n\n  navigation = ({ url }) => {\n    const regex = new RegExp(`^${this.props.callbackUrl}\\[\\?#](.*)$`)\n    \n    const parsedUrl = regex.exec(url)\n    if (parsedUrl) {\n      this.setState({ targetUrl : null })\n      setTimeout(() => {\n        this.setState({ stage: 'confirmation' })\n        const meteorUri = `${this.props.meteorServerProtocol}://${this.props.meteorServerDomain}/_oauth/${this.props.provider.toLowerCase()}?${parsedUrl[1]}`\n        fetch(meteorUri)\n          .then((res) => res.text())\n          .then((text) => {\n            let $ = cheerio.load(text)\n            const config = JSON.parse($('#config').text())\n            Meteor._login({ oauth: {\n              credentialToken: config.credentialToken,\n              credentialSecret: config.credentialSecret\n            }}, (err, res) => {\n              if (err) console.error('Error', err)\n              this.setState({ stage: 'initial' })\n            })\n          })\n          .catch((err) => {\n            console.error('Error', err)\n            this.setState({ stage: 'initial' })\n          })\n      }, 500)\n    }\n  }\n\n  renderStage = (stage, user) => {\n    if (user) {\n      return (<View style={this.styles.view}>\n        <Text style={this.styles.text}>Logged in as {user.profile.name}.</Text>\n        <View style={this.styles.buttonContainer}>\n          <TouchableOpacity onPress={() => Meteor.logout()} style={this.styles.buttonLogout}>\n            <Text style={this.styles.buttonLogoutText}>Logout</Text>\n          </TouchableOpacity>\n        </View>\n      </View>)\n    }\n\n    return {\n      initial: (\n        <View style={this.styles.buttonContainer}>\n          <TouchableOpacity onPress={this.login} style={this.styles.buttonLogin}>\n            <Text style={this.styles.buttonLoginText}>Login with {this.props.provider}</Text>\n          </TouchableOpacity>\n        </View>),\n\n      webView: (\n        <Modal\n          animationType='fade'\n          onRequestClose={() => this.setState({ stage: 'initial' })}\n          visible={!!this.state.targetUrl}\n        >\n          <WebView\n            source={{uri: this.state.targetUrl}}\n            onNavigationStateChange={this.navigation}\n          />\n        </Modal>\n      ),\n\n      confirmation: (<ActivityIndicator animating size='large' />)\n    }[stage]\n  }\n\n  render () {\n    return (\n      <View style={this.styles.view}>\n        {this.renderStage(this.state.stage, this.props.user)}\n      </View>\n    )\n  }\n}\n\nfunction stateParam (loginStyle, credentialToken, redirectUrl) {\n  var state = {\n    loginStyle: loginStyle,\n    credentialToken: credentialToken\n  }\n  if (loginStyle === 'redirect') state.redirectUrl = redirectUrl || null\n  return Base64.encode(JSON.stringify(state))\n}\n\nexport default createContainer((params) => {\n  return {\n    user: Meteor.user()\n  }\n}, Login)\n"]}